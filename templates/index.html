<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Enhancer Pro</title>
    <link rel="stylesheet" href="https://bootswatch.com/5/minty/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4fdf9; }
        .hero-upload {
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 3px dashed #78c2ad;
            border-radius: 20px;
            margin: 20px;
            background-color: white;
            transition: all 0.3s;
        }
        .hero-upload:hover { background-color: #e8f7f3; cursor: pointer; }
        .editor-container { display: none; padding: 20px; }
        .preview-box {
            background: #222;
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        /* Cambiado a IMG para soportar GIF */
        .preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .range-container { margin: 20px 0; }
        .compare-badge {
            position: absolute; top: 10px; left: 10px; 
            padding: 5px 10px; border-radius: 5px; font-weight: bold;
            display: none; z-index: 10;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">VideoEnhancer <i class="fas fa-magic"></i></a>
        </div>
    </nav>

    <!-- Carga -->
    <div class="container" id="uploadSection">
        <div class="hero-upload" onclick="document.getElementById('videoInput').click()">
            <i class="fas fa-cloud-upload-alt fa-5x text-primary mb-3"></i>
            <h3>Haz clic para subir tu video</h3>
            <p class="text-muted">Formatos soportados: MP4, AVI, MOV</p>
            <input type="file" id="videoInput" accept="video/*" style="display: none;" onchange="handleFileUpload(this)">
        </div>
    </div>

    <!-- Editor -->
    <div class="container-fluid editor-container" id="editorSection">
        <div class="row">
            <div class="col-md-8">
                <div class="card border-primary mb-3">
                    <div class="card-header">Previsualización (GIF en bucle)</div>
                    <div class="card-body">
                        
                        <!-- Contenedor Visualización -->
                        <div class="preview-box">
                            <span class="compare-badge text-dark" id="compareBadge">VISTA ORIGINAL</span>
                            <!-- Imagen GIF vacía inicialmente o con placeholder -->
                            <img id="mainPreview" src="" alt="Previsualización" style="display:none;">
                            <div id="placeholderText" class="text-white">Aplica efectos para ver la previsualización</div>
                        </div>
                        
                        <div class="range-container">
                            <label class="form-label text-primary fw-bold">Inicio del GIF: <span id="timeVal">0</span>s</label>
                            <input type="range" class="form-range" id="timeSlider" min="0" value="0" step="1">
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <button id="btnCompare" class="btn btn-warning disabled">
                                <i class="fas fa-exchange-alt"></i> Mantener para Comparar
                            </button>
                            
                            <div class="d-flex gap-2">
                                <button id="btnProcessFull" class="btn btn-success disabled" onclick="startProcessing()">
                                    <i class="fas fa-film"></i> Aplicar a todo el video
                                </button>
                                <a id="downloadLink" href="#" class="btn btn-info disabled" download style="display:none;">
                                    <i class="fas fa-download"></i> Descargar Resultado
                                </a>
                            </div>
                        </div>

                        <!-- Barra de Progreso (Oculta al inicio) -->
                        <div id="progressContainer" class="mt-4" style="display:none;">
                            <label>Procesando video completo: <span id="progressText">0%</span></label>
                            <div class="progress mt-1" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%;"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Panel Derecho (Igual que antes) -->
            <div class="col-md-4">
                <div class="sidebar">
                    <h4 class="mb-3 text-primary">Ajustes</h4>
                    <div class="accordion" id="accordionSettings">
                        <!-- Interpolación -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInterp">Interpolación</button>
                            </h2>
                            <div id="collapseInterp" class="accordion-collapse collapse show" data-bs-parent="#accordionSettings">
                                <div class="accordion-body">
                                    <label>Método</label>
                                    <select class="form-select mb-2" id="interpMethod">
                                        <option value="linear" selected>Bilineal</option>
                                        <option value="cubic">Bicúbica</option>
                                        <option value="lanczos">Lanczos</option>
                                        <option value="nearest">Vecino más cercano</option>
                                    </select>
                                    <label>Escala (1.0 = Original)</label>
                                    <input type="number" class="form-control" id="scaleFactor" value="1.0" step="0.1" min="0.5" max="2.0">
                                </div>
                            </div>
                        </div>
                        <!-- Filtros -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter">Filtros</button>
                            </h2>
                            <div id="collapseFilter" class="accordion-collapse collapse" data-bs-parent="#accordionSettings">
                                <div class="accordion-body">
                                    <select class="form-select mb-2" id="filterType" onchange="toggleFilterParams()">
                                        <option value="none">Ninguno</option>
                                        <option value="bilateral">Bilateral</option>
                                        <option value="gaussian">Gaussiano</option>
                                        <option value="median">Mediana</option>
                                    </select>
                                    <div id="paramsBilateral" class="d-none bg-light p-2 rounded">
                                        <small>Intensidad</small>
                                        <input type="range" class="form-range" id="bilateral_d" min="1" max="15" value="9">
                                        <small>Suavizado</small>
                                        <input type="range" class="form-range" id="bilateral_sigma" min="10" max="150" value="75">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Mejoras -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnhance">Mejoras Visuales</button>
                            </h2>
                            <div id="collapseEnhance" class="accordion-collapse collapse" data-bs-parent="#accordionSettings">
                                <div class="accordion-body">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableClahe">
                                        <label>CLAHE (Contraste)</label>
                                    </div>
                                    <input type="number" class="form-control mb-2" id="claheClip" value="2.0" step="0.5">
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="enableSharpen">
                                        <label>Sharpen (Enfoque)</label>
                                    </div>
                                    <input type="range" class="form-range" id="sharpenStrength" min="1" max="10" value="5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4 btn-lg" onclick="applyPreview()">
                        <i class="fas fa-play-circle"></i> Generar Previsualización (GIF)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideoName = "";
        let originalGifUrl = "";
        let processedGifUrl = "";
        let isProcessed = false;
        let pollInterval = null;

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("video", file);
            document.querySelector('.hero-upload h3').innerText = "Subiendo...";

            fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                currentVideoName = data.video_path;
                const slider = document.getElementById('timeSlider');
                slider.max = Math.floor(data.duration) - 5;
                slider.oninput = function() { document.getElementById('timeVal').innerText = this.value; }
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('editorSection').style.display = 'block';
            });
        }

        function toggleFilterParams() {
            const type = document.getElementById('filterType').value;
            document.getElementById('paramsBilateral').classList.add('d-none');
            if (type === 'bilateral') document.getElementById('paramsBilateral').classList.remove('d-none');
        }

        function getParams() {
            return {
                interpMethod: document.getElementById('interpMethod').value,
                scale_factor: document.getElementById('scaleFactor').value,
                filterType: document.getElementById('filterType').value,
                bilateral_d: document.getElementById('bilateral_d').value,
                bilateral_sigma: document.getElementById('bilateral_sigma').value,
                enable_clahe: document.getElementById('enableClahe').checked ? 'true' : 'false',
                clahe_clip: document.getElementById('claheClip').value,
                enable_sharpen: document.getElementById('enableSharpen').checked ? 'true' : 'false',
                sharpen_strength: document.getElementById('sharpenStrength').value
            };
        }

        function applyPreview() {
            const startTime = document.getElementById('timeSlider').value;
            const params = getParams();
            const imgEl = document.getElementById('mainPreview');
            const placeholder = document.getElementById('placeholderText');
            
            imgEl.style.opacity = 0.3;
            imgEl.style.display = 'block';
            placeholder.innerText = "Generando GIF...";
            
            fetch('/preview_gif', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_name: currentVideoName, start_time: startTime, params: params })
            })
            .then(res => res.json())
            .then(data => {
                processedGifUrl = data.processed_url;
                originalGifUrl = data.original_url;
                
                // Truco para recargar imagen si tiene mismo nombre (timestamp)
                imgEl.src = processedGifUrl + "?t=" + new Date().getTime();
                imgEl.style.opacity = 1;
                placeholder.style.display = 'none';

                document.getElementById('btnCompare').classList.remove('disabled');
                document.getElementById('btnProcessFull').classList.remove('disabled');
                
                const badge = document.getElementById('compareBadge');
                badge.style.display = "block";
                badge.innerText = "VISTA PROCESADA";
                badge.className = "compare-badge bg-success text-white";
                
                isProcessed = true;
            });
        }

        // Lógica de Comparación (Cambiar SRC del GIF)
        const btnCompare = document.getElementById('btnCompare');
        const imgEl = document.getElementById('mainPreview');
        const badge = document.getElementById('compareBadge');

        const showOriginal = () => {
            if (!isProcessed) return;
            imgEl.src = originalGifUrl + "?t=" + new Date().getTime();
            badge.innerText = "VISTA ORIGINAL";
            badge.className = "compare-badge bg-warning text-dark";
        };

        const showProcessed = () => {
            if (!isProcessed) return;
            imgEl.src = processedGifUrl + "?t=" + new Date().getTime();
            badge.innerText = "VISTA PROCESADA";
            badge.className = "compare-badge bg-success text-white";
        };

        btnCompare.addEventListener('mousedown', showOriginal);
        btnCompare.addEventListener('mouseup', showProcessed);
        btnCompare.addEventListener('mouseleave', showProcessed);
        btnCompare.addEventListener('touchstart', (e) => { e.preventDefault(); showOriginal(); });
        btnCompare.addEventListener('touchend', (e) => { e.preventDefault(); showProcessed(); });

        // Lógica de Procesamiento Completo con Barra de Progreso
        function startProcessing() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('btnProcessFull').classList.add('disabled');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            fetch('/start_processing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_name: currentVideoName, params: getParams() })
            })
            .then(res => res.json())
            .then(data => {
                const taskId = data.task_id;
                // Polling cada 1 segundo
                pollInterval = setInterval(() => {
                    fetch('/progress/' + taskId)
                    .then(r => r.json())
                    .then(status => {
                        const pct = status.progress;
                        progressBar.style.width = pct + "%";
                        progressText.innerText = pct + "%";
                        
                        if (status.status === 'completed') {
                            clearInterval(pollInterval);
                            progressBar.classList.remove('progress-bar-animated');
                            
                            const dlBtn = document.getElementById('downloadLink');
                            dlBtn.href = status.download_url;
                            dlBtn.style.display = 'inline-block';
                            dlBtn.classList.remove('disabled');
                            dlBtn.innerText = "DESCARGAR VIDEO";
                        }
                    });
                }, 1000);
            });
        }
    </script>
</body>
</html>